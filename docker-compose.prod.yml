version: "3.7"
services:
  cloudflare:
    image: cloudflare/cloudflared:latest
    container_name: "cloudflare"
    volumes: [./cloudflare/prod:/home/nonroot/.cloudflared]
    command: tunnel run

  auth: # keycloak
    image: quay.io/keycloak/keycloak:latest
    container_name: "account_auth"
    command: start-dev
    env_file: [account.env]
    volumes:
      - ./auth/merge.sh:/opt/keycloak/merge.sh
      - ./auth/themes:/opt/keycloak/themes

  api: # hasura
    build:
      context: .docker
      dockerfile: api.Dockerfile
    container_name: "account_api"
    volumes: [./api:/hasura]
    env_file: [account.env]

  front: # nextjs
    build:
      context: .docker
      dockerfile: frontend.Dockerfile
    container_name: account_front
    command: sh -c "npm install && npm run build && npm run start"
    volumes: [.:/repo]
    environment: [WATCHPACK_POLLING=true]
    env_file: [account.env]
